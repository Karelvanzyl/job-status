<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Status - Tap Tap Plumb</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-slate-50 min-h-screen p-4">
  <div id="app" class="max-w-2xl mx-auto py-8"></div>

  <script>
    // IMPORTANT: REPLACE WITH YOUR BASE44 APP SUBDOMAIN
    const BASE44_APP_URL = 'https://tap-tap-jobcards-a68f9894.base44.app';

    async function fetchJobStatus(token) {
      try {
        const response = await fetch(`${BASE44_APP_URL}/api/getJobStatus?token=${token}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Job not found');
        }
        
        return { job: data.job, business: data.business };
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }

    const statusSteps = [
      { key: 'pending', label: 'Job Created' },
      { key: 'scheduled', label: 'Scheduled' },
      { key: 'on_way_to_site', label: 'Technician On The Way' },
      { key: 'in_progress', label: 'Work In Progress' },
      { key: 'completed', label: 'Job Completed' }
    ];

    const statusOrder = {
      'pending': 0, 'open': 0, 'scheduled': 1,
      'on_way_to_site': 2, 'in_progress': 3,
      'quote_sent': 3, 'quote_accepted': 3,
      'awaiting_payment': 4, 'completed': 5
    };

    function renderJobStatus(job, settings) {
      const currentOrder = statusOrder[job.status] || 0;
      const companyName = settings?.company_name || 'Tap Tap Plumb';

      if (job.status === 'completed') {
        return `
          <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="w-16 h-16 rounded-full bg-emerald-100 flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Job Completed!</h2>
            <p class="text-slate-600">Your job has been successfully completed. Thank you for choosing ${companyName}!</p>
            ${job.completed_date ? `<p class="text-sm text-slate-500 mt-4">Completed on ${new Date(job.completed_date).toLocaleDateString()}</p>` : ''}
          </div>
        `;
      }

      return `
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
          ${settings?.logo_url ? `
            <div class="flex justify-center mb-8">
              <img src="${settings.logo_url}" alt="${companyName}" class="h-20 object-contain">
            </div>
          ` : `
            <div class="flex justify-center mb-8">
              <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                </svg>
              </div>
            </div>
          `}

          <div class="mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">${job.job_type || 'Service Request'}</h1>
            <p class="text-slate-600">Job for ${job.customer_name || 'Customer'}</p>
          </div>

          <div class="space-y-4 mb-8">
            ${statusSteps.map((step, i) => {
              const isCompleted = currentOrder > i;
              const isCurrent = currentOrder === i;
              return `
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0 transition-all ${
                    isCompleted ? 'bg-emerald-500 text-white shadow-lg' :
                    isCurrent ? 'bg-blue-500 text-white shadow-lg animate-pulse' :
                    'bg-slate-200 text-slate-400'
                  }">
                    ${isCompleted ? `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>` : 
                    `<span class="text-lg font-semibold">${i + 1}</span>`}
                  </div>
                  <div class="flex-1">
                    <p class="font-medium ${isCompleted || isCurrent ? 'text-slate-900' : 'text-slate-400'}">${step.label}</p>
                    ${isCurrent ? '<p class="text-sm text-blue-600 font-medium">Current Status</p>' : ''}
                  </div>
                  ${isCompleted ? `<svg class="w-6 h-6 text-emerald-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>` : ''}
                </div>
              `;
            }).join('')}
          </div>

          <div class="border-t pt-6 space-y-4">
            ${job.scheduled_date ? `
              <div class="flex items-center gap-3 text-slate-600">
                <svg class="w-5 h-5 text-slate-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <p class="text-sm text-slate-500">Scheduled</p>
                  <p class="font-medium">${new Date(job.scheduled_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}${job.scheduled_time ? ` at ${job.scheduled_time}` : ''}</p>
                </div>
              </div>
            ` : ''}

            ${job.customer_address ? `
              <div class="flex items-center gap-3 text-slate-600">
                <svg class="w-5 h-5 text-slate-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div>
                  <p class="text-sm text-slate-500">Location</p>
                  <p class="font-medium">${job.customer_address}</p>
                </div>
              </div>
            ` : ''}

            ${job.assigned_tech ? `
              <div class="flex items-center gap-3 text-slate-600">
                <svg class="w-5 h-5 text-slate-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <div>
                  <p class="text-sm text-slate-500">Assigned Technician</p>
                  <p class="font-medium">${job.assigned_tech}</p>
                  ${job.assigned_tech_phone ? `
                    <a href__="tel:${job.assigned_tech_phone}" class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1 mt-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                      </svg>
                      ${job.assigned_tech_phone}
                    </a>
                  ` : ''}
                </div>
              </div>
            ` : ''}

            ${job.description ? `
              <div class="pt-4 border-t">
                <p class="text-sm text-slate-500 mb-2">Job Description</p>
                <p class="text-slate-700">${job.description}</p>
              </div>
            ` : ''}
          </div>

          <div class="mt-8 pt-6 border-t text-center text-sm text-slate-500">
            <p>Questions? Contact ${companyName} for assistance.</p>
            <p class="mt-1 text-xs">This page updates automatically every 30 seconds.</p>
          </div>
        </div>
      `;
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const app = document.getElementById('app');

      if (!token) {
        app.innerHTML = `
          <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <h2 class="text-xl font-bold text-slate-900 mb-2">No Access Token</h2>
            <p class="text-slate-600">Please use the link provided in your WhatsApp message.</p>
          </div>
        `;
        return;
      }

      app.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
          <p class="text-slate-600">Loading job status...</p>
        </div>
      `;

      const result = await fetchJobStatus(token);

      if (!result || !result.job) {
        app.innerHTML = `
          <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Job Not Found</h2>
            <p class="text-slate-600">The job you are looking for does not exist or the link may have expired.</p>
          </div>
        `;
        return;
      }

      app.innerHTML = renderJobStatus(result.job, result.business);

      // Refresh every 30 seconds
      setInterval(async () => {
        const updated = await fetchJobStatus(token);
        if (updated && updated.job) {
          app.innerHTML = renderJobStatus(updated.job, updated.business);
        }
      }, 30000);
    }

    init();
  </script>
</body>
</html>